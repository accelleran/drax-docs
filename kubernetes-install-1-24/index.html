
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://accelleran.github.io/drax-docs-2022-3-1/kubernetes-install-1-24/">
      
      <link rel="icon" href="../images/accelleran_favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.0">
    
    
      
        <title>Kubernetes Installation (v1.24) - dRAX - 2022.3.0 release</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fe914879.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ba0d045b.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubernetes-installation-v124" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="dRAX - 2022.3.0 release" class="md-header__button md-logo" aria-label="dRAX - 2022.3.0 release" data-md-component="logo">
      
  <img src="../images/accelleran_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            dRAX - 2022.3.0 release
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Kubernetes Installation (v1.24)
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Accelleran CU Install Guide
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../kubernetes-install/" class="md-tabs__link">
      CU installation ( VM & kubernetes )
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../drax-install/" class="md-tabs__link">
      RIC & CU Installation
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../du-install/" class="md-tabs__link">
      DU Installation
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../core-install/" class="md-tabs__link">
      Core Installation
    </a>
  </li>

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="dRAX - 2022.3.0 release" class="md-nav__button md-logo" aria-label="dRAX - 2022.3.0 release" data-md-component="logo">
      
  <img src="../images/accelleran_logo.png" alt="logo">

    </a>
    dRAX - 2022.3.0 release
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Accelleran CU Install Guide
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes-install/" class="md-nav__link">
        CU installation ( VM & kubernetes )
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../drax-install/" class="md-nav__link">
        RIC & CU Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../du-install/" class="md-nav__link">
        DU Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../core-install/" class="md-nav__link">
        Core Installation
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="kubernetes-installation-v124">Kubernetes Installation (v1.24)<a class="headerlink" href="#kubernetes-installation-v124" title="Permanent link">&para;</a></h1>
<p>This chapter will install Kubernetes, using Flannel for the CNI.
This guide defaults to using Containerd as the container runtime.
For more information on installing Kubernetes, see the <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">official Kubernetes documentation</a>.</p>
<h2 id="disable-swap">Disable Swap<a class="headerlink" href="#disable-swap" title="Permanent link">&para;</a></h2>
<p>Kubernetes refuses to run if swap is enabled on the node, so we disable swap immediately and then also disable it following a reboot:</p>
<div class="highlight"><pre><span></span><code>sudo swapoff -a
sudo sed -i <span class="s1">&#39;/\sswap\s/ s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</code></pre></div>
<h2 id="install-kubernetes-and-suplemental-libraries">Install Kubernetes and suplemental libraries<a class="headerlink" href="#install-kubernetes-and-suplemental-libraries" title="Permanent link">&para;</a></h2>
<p>Add the Kubernetes APT repository:</p>
<div class="highlight"><pre><span></span><code>sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
<span class="nb">echo</span> <span class="s2">&quot;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
</code></pre></div>
<p>Accelleran dRAX currently supports Kubernetes up to version 1.24. The following command installs specifically this (1.24) version of k8s together with containerd end suplemental libraries:</p>
<div class="highlight"><pre><span></span><code>sudo apt-get install -y runc libc6 containerd <span class="nv">kubelet</span><span class="o">=</span><span class="m">1</span>.24.0-00 <span class="nv">kubeadm</span><span class="o">=</span><span class="m">1</span>.24.0-00 <span class="nv">kubectl</span><span class="o">=</span><span class="m">1</span>.24.0-00
sudo apt-mark hold kubelet kubeadm kubectl
</code></pre></div>
<h2 id="configure-containerd">Configure Containerd<a class="headerlink" href="#configure-containerd" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>sudo rm -rf /etc/containerd/config.toml
sudo systemctl restart containerd.service
sudo systemctl <span class="nb">enable</span> containerd.service
sudo sysctl -p
</code></pre></div>
<h2 id="letting-iptables-see-bridged-traffic-and-ip-forwarding-enabling">Letting IPTables See Bridged Traffic and IP Forwarding Enabling<a class="headerlink" href="#letting-iptables-see-bridged-traffic-and-ip-forwarding-enabling" title="Permanent link">&para;</a></h2>
<p>In order k8s nodes can see bringed traffic properly, iptables should be configured to allow bringed traffic together with enabled ip-forwarding.  </p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;net.bridge.bridge-nf-call-iptables=1&quot;</span> <span class="p">|</span> sudo tee -a /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">&quot;net.ipv4.ip_forward=1&quot;</span> <span class="p">|</span> sudo tee -a /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">&quot;net.ipv6.conf.all.forwarding=1&quot;</span> <span class="p">|</span> sudo tee -a /etc/sysctl.conf
sudo modprobe br_netfilter
</code></pre></div>
<h2 id="configure-kubernetes">Configure Kubernetes<a class="headerlink" href="#configure-kubernetes" title="Permanent link">&para;</a></h2>
<p>To initialize the Kubernetes cluster, the IP address of the node needs to be fixed, i.e. if this IP changes, a full re-installation of Kubernetes will be required.
This is generally the (primary) IP address of the network interface associated with the default gateway.
From here on, this IP is referred to as <code>$NODE_IP</code> - we store it as an environment variable for later use:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">NODE_IP</span><span class="o">=</span><span class="m">1</span>.2.3.4   <span class="c1"># replace 1.2.3.4 with the correct IP</span>
</code></pre></div>
<p>This guide assumes we will use Flannel as the CNI-based Pod network for this Kubernetes instance, which uses the <code>10.244.0.0/16</code> subnet by default.
We store it again as an environment variable for later use, and of course if you wish to use a different subnet, change the command accordingly:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">POD_NETWORK</span><span class="o">=</span><span class="m">10</span>.244.0.0/16
</code></pre></div>
<p>The following command initializes the cluster on this node:</p>
<div class="highlight"><pre><span></span><code>sudo kubeadm init --pod-network-cidr<span class="o">=</span><span class="nv">$POD_NETWORK</span> --apiserver-advertise-address<span class="o">=</span><span class="nv">$NODE_IP</span>
</code></pre></div>
<p>If this succeeds, we should see information for joining other worker nodes to this cluster.
We won't do that at this point, but it's a sign that the command completed successfully.</p>
<p>To make kubectl work for our non-root user, run the following commands:</p>
<div class="highlight"><pre><span></span><code>mkdir -p <span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.kube&quot;</span>
sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
sudo chown <span class="s2">&quot;</span><span class="k">$(</span>id -u<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>id -g<span class="k">)</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.kube/config&quot;</span>
</code></pre></div>
<h2 id="install-flannel">Install Flannel<a class="headerlink" href="#install-flannel" title="Permanent link">&para;</a></h2>
<p>Prepare the Manifest file:</p>
<div class="highlight"><pre><span></span><code>curl -sSOJ https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
sed -i <span class="s1">&#39;/net-conf.json/,/}/{ s#10.244.0.0/16#&#39;</span><span class="s2">&quot;</span><span class="nv">$POD_NETWORK</span><span class="s2">&quot;</span><span class="s1">&#39;#; }&#39;</span> kube-flannel.yml
</code></pre></div>
<p>Apply the Manifest file:</p>
<div class="highlight"><pre><span></span><code>kubectl apply -f kube-flannel.yml
</code></pre></div>
<h2 id="enable-pod-scheduling">Enable Pod Scheduling<a class="headerlink" href="#enable-pod-scheduling" title="Permanent link">&para;</a></h2>
<p>By default, Kubernetes will not schedule Pods on the control-plane node for security reasons.
As we're running with a single Node, we need to remove the node-role.kubernetes.io/control-plane- taint, meaning that the scheduler will then be able to schedule Pods on it.</p>
<div class="highlight"><pre><span></span><code>kubectl taint node --all node-role.kubernetes.io/control-plane-
</code></pre></div>
<h2 id="deploy-longhorn-as-the-default-persistent-storage">Deploy Longhorn as the Default Persistent Storage<a class="headerlink" href="#deploy-longhorn-as-the-default-persistent-storage" title="Permanent link">&para;</a></h2>
<p>First create the longhorn-system namespace:
<div class="highlight"><pre><span></span><code>kubectl create namespace longhorn-system
</code></pre></div>
Then add the longhorn repository to helm:
<div class="highlight"><pre><span></span><code>helm repo add longhorn https://charts.longhorn.io
</code></pre></div>
Finally deploy Longhorn in "longhorn-system" namespace, with all replica counts set to 1 and UI exposed on port 32100 via NodePort instead of ClusterIp:
<div class="highlight"><pre><span></span><code>helm install longhorn longhorn/longhorn --version <span class="m">1</span>.3.1 <span class="se">\</span>
--set service.ui.type<span class="o">=</span>NodePort,<span class="se">\</span>
service.ui.nodePort<span class="o">=</span><span class="m">32100</span>,<span class="se">\</span>
persistence.defaultClassReplicaCount<span class="o">=</span><span class="m">1</span>,<span class="se">\</span>
csi.attacherReplicaCount<span class="o">=</span><span class="m">1</span>,<span class="se">\</span>
csi.provisionerReplicaCount<span class="o">=</span><span class="m">1</span>,<span class="se">\</span>
csi.resizerReplicaCount<span class="o">=</span><span class="m">1</span>,<span class="se">\</span>
csi.snapshotterReplicaCount<span class="o">=</span><span class="m">1</span>,<span class="se">\</span>
defaultSettings.defaultReplicaCount<span class="o">=</span><span class="m">1</span> <span class="se">\</span>
-n longhorn-system
</code></pre></div></p>
<h2 id="a-small-busybox-pod-for-testing">A small busybox pod for testing<a class="headerlink" href="#a-small-busybox-pod-for-testing" title="Permanent link">&para;</a></h2>
<p>It is very convenient (however optional) to test the Kubernetes installation with a simple busybox pod for instance to test your DNS resolution inside a pod. To do so create the following yaml file (/tmp/busybox.yaml):</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt; EOF &gt; /tmp/busybox.yaml</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Pod</span>
<span class="s">metadata:</span>
<span class="s"> name: busybox</span>
<span class="s"> namespace: default</span>
<span class="s">spec:</span>
<span class="s"> containers:</span>
<span class="s"> - name: busybox</span>
<span class="s">   image: busybox:1.28</span>
<span class="s">   command:</span>
<span class="s">     - sleep</span>
<span class="s">     - &quot;3600&quot;</span>
<span class="s">   imagePullPolicy: IfNotPresent</span>
<span class="s"> restartPolicy: Always</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Then you can create the pod:
NOTE : --kubeconfig is optional here because <code>$HOME/.kube/config</code> is the default config file</p>
<div class="highlight"><pre><span></span><code>kubectl --kubeconfig <span class="nv">$HOME</span>/.kube/config create -f /tmp/busybox.yaml
</code></pre></div>
<p>If all went well a new POD was created, you can verify this with the following command</p>
<div class="highlight"><pre><span></span><code>kubectl --kubeconfig <span class="nv">$HOME</span>/.kube/config get pods
<span class="c1">#NAME      READY STATUS    RESTARTS AGE</span>
<span class="c1">#busybox   1/1 Running   21 21h</span>
</code></pre></div>
<p>In order to verify if your Kubernetes is working correctly you could try some simple commands using the busybox POD. 
For instance to verify your name resolution works do:</p>
<div class="highlight"><pre><span></span><code>kubectl <span class="nb">exec</span> -ti busybox -- nslookup mirrors.ubuntu.com 
<span class="c1">#Server:    10.96.0.10</span>
<span class="c1">#Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span>

<span class="c1">#Name:      mirrors.ubuntu.com</span>
<span class="c1">#Address 1: 91.189.89.32 bilimbi.canonical.com</span>
</code></pre></div>
<h2 id="remove-in-full-a-kubernetes-installation">Remove in full a Kubernetes installation<a class="headerlink" href="#remove-in-full-a-kubernetes-installation" title="Permanent link">&para;</a></h2>
<p>On occasion, it may be deemed necessary to fully remove Kubernetes, for instance if for any reason your server IP address will change, then the advertised Kubernetes IP address will have to follow. THe following command help making sure the previous installation is cleared up: </p>
<div class="highlight"><pre><span></span><code>sudo kubeadm reset
sudo apt-get purge kubeadm kubectl kubelet kubernetes-cni kube*
sudo rm -rf ~/.kube
sudo rm -rf /etc/cni/net.d
sudo ip link delete cni0
sudo ip link delete flannel.1
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.expand", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "toc.integrate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.53c85856.min.js", "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.716f8af4.min.js"></script>
      
    
  </body>
</html>