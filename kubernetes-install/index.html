
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://accelleran.github.io/drax-docs/kubernetes-install/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.0">
    
    
      
        <title>Kubernetes Installation - dRAX</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fe914879.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ba0d045b.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubernetes-installation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="dRAX" class="md-header__button md-logo" aria-label="dRAX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            dRAX
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Kubernetes Installation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Overview
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../core-install/" class="md-tabs__link">
      Core Installation
    </a>
  </li>

      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="./" class="md-tabs__link md-tabs__link--active">
      Kubernetes Installation
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../drax-install/" class="md-tabs__link">
      dRAX Installation
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../du-install/" class="md-tabs__link">
      DU Installation
    </a>
  </li>

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="dRAX" class="md-nav__button md-logo" aria-label="dRAX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    dRAX
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../core-install/" class="md-nav__link">
        Core Installation
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          <span class="md-nav__icon md-icon"></span>
          
            <a href="./" class="md-nav__link md-nav__link--active"
              style="margin: initial; padding: initial; pointer-events: initial">
          
            Kubernetes Installation
          </a>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Kubernetes Installation
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#install-docker" class="md-nav__link">
    Install Docker
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-docker-daemon" class="md-nav__link">
    Configure Docker Daemon
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disable-swap" class="md-nav__link">
    Disable Swap
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-kubernetes" class="md-nav__link">
    Configure Kubernetes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-flannel" class="md-nav__link">
    Install Flannel
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../drax-install/" class="md-nav__link">
        dRAX Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../du-install/" class="md-nav__link">
        DU Installation
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="kubernetes-installation">Kubernetes Installation<a class="headerlink" href="#kubernetes-installation" title="Permanent link">⚓︎</a></h1>
<p>This chapter will install Kubernetes, using Flannel for the CNI.
This guide defaults to using Docker as the container runtime.
For more information on installing Kubernetes, see the <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">official Kubernetes documentation</a>.</p>
<h2 id="install-docker">Install Docker<a class="headerlink" href="#install-docker" title="Permanent link">⚓︎</a></h2>
<p>Add the Docker APT repository:</p>
<div class="highlight"><pre><span></span><code>curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
<span class="nb">echo</span> <span class="s2">&quot;deb [arch=</span><span class="k">$(</span>dpkg --print-architecture<span class="k">)</span><span class="s2"> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu </span><span class="k">$(</span>lsb_release -cs<span class="k">)</span><span class="s2"> stable&quot;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
sudo apt update
</code></pre></div>
<p>Install the required packages:</p>
<div class="highlight"><pre><span></span><code>sudo apt install docker-ce docker-ce-cli containerd.io docker-compose
</code></pre></div>
<p>Add your user to the docker group to be able to run docker commands without sudo access.
You might have to reboot or log out and in again for this change to take effect.</p>
<div class="highlight"><pre><span></span><code>sudo usermod -aG docker <span class="nv">$USER</span>
</code></pre></div>
<p>To check if your installation is working you can try to run a test image in a container:</p>
<div class="highlight"><pre><span></span><code>docker run hello-world
</code></pre></div>
<h2 id="configure-docker-daemon">Configure Docker Daemon<a class="headerlink" href="#configure-docker-daemon" title="Permanent link">⚓︎</a></h2>
<p>The recommended configuration of the Docker daemon is provided by the Kubernetes team - particularly to use systemd for the management of the container's cgroups:</p>
<div class="highlight"><pre><span></span><code>sudo mkdir /etc/docker
sudo tee /etc/docker/daemon.json <span class="s">&lt;&lt;EOF</span>
<span class="s">{</span>
<span class="s">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span>
<span class="s">  &quot;log-driver&quot;: &quot;json-file&quot;,</span>
<span class="s">  &quot;log-opts&quot;: {</span>
<span class="s">    &quot;max-size&quot;: &quot;100m&quot;</span>
<span class="s">  },</span>
<span class="s">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span>
<span class="s">}</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Restart Docker and enable on boot:</p>
<div class="highlight"><pre><span></span><code>sudo systemctl <span class="nb">enable</span> docker
sudo systemctl daemon-reload
sudo systemctl restart docker
</code></pre></div>
<h2 id="disable-swap">Disable Swap<a class="headerlink" href="#disable-swap" title="Permanent link">⚓︎</a></h2>
<p>Kubernetes refuses to run if swap is enabled on the node, so we disable swap immediately and then also disable it following a reboot:</p>
<div class="highlight"><pre><span></span><code>sudo swapoff -a
sudo sed -i <span class="s1">&#39;/\sswap\s/ s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
<span class="sb">```</span> bash

<span class="c1">## Install Kubernetes</span>

Add the Kubernetes APT repository:

<span class="sb">```</span> bash
sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
<span class="nb">echo</span> <span class="s2">&quot;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
</code></pre></div>
<p>Accelleran dRAX currently supports Kubernetes up to version 1.20. The following command installs specifically this version:</p>
<div class="highlight"><pre><span></span><code>sudo apt install -y <span class="nv">kubelet</span><span class="o">=</span><span class="m">1</span>.20.0-00 <span class="nv">kubeadm</span><span class="o">=</span><span class="m">1</span>.20.0-00 <span class="nv">kubectl</span><span class="o">=</span><span class="m">1</span>.20.0-00
sudo apt-mark hold kubelet kubeadm kubectl
</code></pre></div>
<h2 id="configure-kubernetes">Configure Kubernetes<a class="headerlink" href="#configure-kubernetes" title="Permanent link">⚓︎</a></h2>
<p>To initialize the Kubernetes cluster, the IP address of the node needs to be fixed, i.e. if this IP changes, a full re-installation of Kubernetes will be required.
This is generally the (primary) IP address of the network interface associated with the default gateway.
From here on, this IP is referred to as <code>$NODE_IP</code> - we store it as an environment variable for later use:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">NODE_IP</span><span class="o">=</span><span class="m">1</span>.2.3.4   <span class="c1"># replace 1.2.3.4 with the correct IP</span>
</code></pre></div>
<p>This guide assumes we will use Flannel as the CNI-based Pod network for this Kubernetes instance, which uses the <code>10.244.0.0/16</code> subnet by default.
If you wish to use a different subnet, change it in the following command where we store it again as an environment variable for later use:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">POD_NETWORK</span><span class="o">=</span><span class="m">10</span>.244.0.0/16
</code></pre></div>
<p>The following command initializes the cluster on this node:</p>
<div class="highlight"><pre><span></span><code>sudo kubeadm init --pod-network-cidr<span class="o">=</span><span class="nv">$POD_NETWORK</span> --apiserver-advertise-address<span class="o">=</span><span class="nv">$NODE_IP</span>
</code></pre></div>
<p>If this succeeds, we should see information for joining other worker nodes to this cluster.
We won't do that at this point, but it's a sign that the command completed successfully.</p>
<p>To make kubectl work for our non-root user, run the following commands:</p>
<div class="highlight"><pre><span></span><code>mkdir -p <span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.kube&quot;</span>
sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
sudo chown <span class="s2">&quot;</span><span class="k">$(</span>id -u<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>id -g<span class="k">)</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.kube/config&quot;</span>
</code></pre></div>
<p>By default, Kubernetes will not schedule Pods on the control-plane node for security reasons.
As we're running with a single Node, we need to remove the node-role.kubernetes.io/master taint, meaning that the scheduler will then be able to schedule Pods on it.</p>
<div class="highlight"><pre><span></span><code>kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre></div>
<h2 id="install-flannel">Install Flannel<a class="headerlink" href="#install-flannel" title="Permanent link">⚓︎</a></h2>
<p>Prepare the Manifest file:</p>
<div class="highlight"><pre><span></span><code>curl -sSOJ https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
sed -i <span class="s1">&#39;/net-conf.json/,/}/{ s#10.244.0.0/16#&#39;</span><span class="s2">&quot;</span><span class="nv">$POD_NETWORK</span><span class="s2">&quot;</span><span class="s1">&#39;#; }&#39;</span> kube-flannel.yml
</code></pre></div>
<p>Apply the Manifest file:</p>
<div class="highlight"><pre><span></span><code>kubectl apply -f kube-flannel.yml
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../core-install/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Core Installation" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Core Installation
            </div>
          </div>
        </a>
      
      
        
        <a href="../drax-install/" class="md-footer__link md-footer__link--next" aria-label="Next: dRAX Installation" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              dRAX Installation
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.expand", "navigation.indexes", "navigation.top", "navigation.tabs", "toc.integrate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.53c85856.min.js", "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.716f8af4.min.js"></script>
      
    
  </body>
</html>